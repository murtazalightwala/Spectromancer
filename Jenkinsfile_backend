node {
  stage('SCM') {
    checkout scm
  }
  stage('SonarQube Analysis') {
    def scannerHome = tool 'Sonarscanner';
    withSonarQubeEnv(installationName: 'sonarqube', credentialsId: 'sonar-spectro-backend') {
      sh "${scannerHome}/bin/sonar-scanner"
    }
  }
  stage('Tests') {
    sh "curl -sSL https://install.python-poetry.org | python3 -";
    sh "/root/.local/bin/poetry install";
    sh "/root/.local/bin/poetry run python3 -m pytest tests/backend_tests.py";
  }
  stage('Code Merge'){
    git branch: 'main', credentialsId: 'murtaza_lightwala_github_creds', url: 'https://github.com/murtazalightwala/Spectromancer';
    sh 'git remote set-url origin $repository'
    sh 'git checkout staging';
    sh 'git merge main';
    sh 'git commit -m lele';
    sh 'git push origin staging';
  }
}